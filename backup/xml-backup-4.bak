import xml.etree.ElementTree as ET
import d_contents as data
from pathlib import Path

color_directory_background = '#0083d5'
color_directory_light = '#12c5ff'
color_directory_dark = '#1075f6'
color_glyph_light = '#126c98'
color_glyph_dark = '#0b4f94'

id_gradient_directory = 'directory-gradient'
id_gradient_glyph = 'glyph-gradient'

def normalized_svg_file(file: Path) -> Path:
    if not file.name.endswith('.svg'):
        stringfied = str(file)
        stringfied += '.svg'
        file = Path(stringfied)
    
    return file

def normalize_hex_value(color_hex: str) -> str:
    # adiciona # na frente do valor hex se ele já não tiver
    if not color_hex.startswith('#'):
        color_hex = f'#{color_hex}'
    
    # se tiver mais de 7 dígitos no hex (contando com a # no começo)
    # obtendo apenas do índice 0 até o 7, removendo os últimos 2 (ou mais) dígitos que indicam a opacidade da cor
    # a opacidade pode fazer a cor quebrar no svg se estiver presente. ela deve ser definida com fill-opacity
    if len(color_hex) > 7:
        color_hex = color_hex[:7]

    return color_hex

def draw_directory(svg: ET.Element, hex_background: str, gradient_id: str, group_id: str = 'directory-group'):
    group = ET.SubElement(svg, 'g', {
        'id': group_id,
        'transform': 'scale(.75)'
    })

    # background do diretório, um retangulo com cor sólida
    hex_background = normalize_hex_value(hex_background)
    ET.SubElement(group, 'path', {
        'd': 'm61.122 15.88c0-2.762-2.239-5-5-5h-48.244c-2.761 0-5 2.238-5 5v32.246c0 2.761 2.239 5 5 5h48.244c2.761 0 5-2.239 5-5v-32.246z',
        'style': f'fill:{hex_background}; fill-opacity:1',
    })

    # parte da frente do diretório, com curvas e gradiente
    ET.SubElement(group, 'path', {
        'd': 'm61.122 20.652c0-1.326-0.527-2.598-1.465-3.536-0.938-0.937-2.209-1.464-3.535-1.464h-25.58c-1.232 0-2.42-0.455-3.337-1.277-0.768-0.689-1.713-1.535-2.481-2.224-0.917-0.822-2.105-1.277-3.337-1.277h-13.509c-1.326 0-2.597 0.527-3.535 1.465-0.938 0.937-1.465 2.209-1.465 3.535v32.252c0 2.761 2.239 5 5 5h48.244c2.761 0 5-2.239 5-5v-27.474z',
        'style': f'fill:url(#{gradient_id}); fill-opacity:1'
    })

def draw_glyph(svg: ET.Element, d_contents: str, gradient_id: str, group_id:str = 'glyph-group', requires_scale: bool = False):
    # os atributos aqui são definidos separadamente pra poder aplicar a scale só se necessário
    # alguns glifos precisam, se não ficam muito pequenos
    # enquanto outros não precisam, se não ficam muito grandes
    # o jeito de saber quais precisam ou não é gerar os svgs com todos os glifos e olhar manualmente
    attributes = {
        'id': group_id
    }
    if requires_scale:
        attributes['transform'] = 'scale(.75)'
    
    group = ET.SubElement(svg, 'g', attributes)

    ET.SubElement(group, 'path', {
        'd': d_contents,
        'style': f'fill:url(#{gradient_id}); fill-opacity:1'
    })

def generate_svg(
    output_file: Path,
    hex_directory_background: str,
    hex_directory_dark: str,
    hex_directory_light: str,
    hex_glyph_dark: str,
    hex_glyph_light: str,
    glyph_d_contents: str | None = None
    ):
    # elemento <svg> principal que contém todo o conteúdo
    # todo elemento (exceto o <xml>, se presente) deve ser um subelemento daqui
    #
    # esses valores nele são o que geralmente já tem no ícone base de diretório do kora
    # ex: <svg style=x viewBox=y xmlns=z</svg>
    svg = ET.Element('svg', {
        'xmlns': 'http://www.w3.org/2000/svg',
        'viewBox': '0 0 48 48',
        'style': 'clip-rule:evenodd;fill-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2'
    })

    # definições de gradientes
    # os ids definidos aqui são os que serão passados como argumentos pras outras funções auxiliares
    defs = ET.SubElement(svg, 'defs')
    
    grad_dir = ET.SubElement(defs, 'linearGradient', {
        'id': id_gradient_directory,
        'x2': '1',
        'gradientTransform': 'matrix(2.54933e-15,-41.6338,41.6338,2.54933e-15,445.153,52.7218)',
        'gradientUnits': 'userSpaceOnUse',
    })
    ET.SubElement(grad_dir, 'stop', {
        'style': f'stop-color:{hex_directory_dark}',
        'offset': '0'
    })
    ET.SubElement(grad_dir, 'stop', {
        'style': f'stop-color:{hex_directory_light}',
        'offset': '1'
    })

    grad_glyph = ET.SubElement(defs, 'linearGradient', {
        'id': id_gradient_glyph,
        'x2': '1',
        'gradientTransform': 'matrix(1.77928e-15,29.0579,-29.0579,1.77928e-15,-583.701,19.4233)',
        'gradientUnits': 'userSpaceOnUse',
    })
    ET.SubElement(grad_glyph, 'stop', {
        'style': f'stop-color:{hex_glyph_light}',
        'offset': '0',
    })
    ET.SubElement(grad_glyph, 'stop', {
        'style': f'stop-color:{hex_glyph_dark}',
        'offset': '1',
    })

    # grupos (<g> -> grupo)
    # o id deles é o equivalente ao nome que vai aparecer no inkscape
    #
    # desenhar de fato os elementos, usando sempre um diretório padrão como base
    # o glifo por cima do ícone de diretório só vai ser desenhado se ele tiver sido passado
    draw_directory(svg=svg, hex_background=hex_directory_background, gradient_id=id_gradient_directory)
    if glyph_d_contents is not None:
        draw_glyph(svg=svg, d_contents=glyph_d_contents, gradient_id=id_gradient_glyph)

    # indentar os conteúdos com x espaços, se não eles ficam todos numa linha só
    ET.indent(svg, space='  ', level=0)

    # converter pra string e escrever o xml gerado em um arquivo svg
    xml_str = ET.tostring(svg, encoding='utf-8', xml_declaration=True).decode('utf-8')
    with output_file.open('w') as f:
        f.write(xml_str)

def handle_color_map(output_directory: Path, c_map: dict, icon_name: str, glyph_d_contents: str | None = None):
    # obter os valores do mapa
    directory_background = c_map.get('directory-background')
    directory_light = c_map.get('directory-light')
    directory_dark = c_map.get('directory-dark')
    glyph_light = c_map.get('glyph-light')
    glyph_dark = c_map.get('glyph-dark')

    variables = [directory_background, directory_light, directory_dark, glyph_dark, glyph_light]
    for v in variables:
        if v is None:
            print(f'{v} é um valor nulo')
            return
        
        v = normalize_hex_value(v)

    # construir + normalizar o caminho final e gerar o svg
    output_directory.mkdir(parents=True, exist_ok=True)
    final = output_directory / icon_name
    final = normalized_svg_file(final)

    generate_svg(
        output_file=final,
        hex_directory_background=directory_background,
        hex_directory_dark=directory_dark,
        hex_directory_light=directory_light,
        hex_glyph_dark=glyph_dark,
        hex_glyph_light=glyph_light,
        glyph_d_contents=glyph_d_contents
    )

map_blue = {
    'directory-background': '#0083d5',
    'directory-light': '#12c5ff',
    'directory-dark': '#1075f6',
    'glyph-light': '#126c98',
    'glyph-dark': '#0b4f94'
}

dir_map = {
    'bookmark-missing': data.half_star,
    'folder-3dprint': data.cube_3d,
    'folder-activities': data.three_dots,
    'folder-add': data.plus,
    'folder-android': data.android,
    'folder-applications': data.capital_a,
    'folder-arduino': data.arduino,
    'folder-backup': data.arrow_cycle,
    'folder-books': data.book,
    'folder-cd': data.cd,
    'folder-copy-cloud': data.copy_cloud,
    'folder-documents': data.document,
    'folder-download': data.two_arrows_down,
    'folder-dropbox': data.dropbox,
    'folder-favorites': data.star,
    'folder-games': data.controller,
    'folder-gdrive': data.google_drive,
    'folder-git': data.git,
    'folder-github': data.github,
    'folder-gitlab': data.gitlab
}

def main():
    for name, data in dir_map.items():
        handle_color_map(
            output_directory=Path('./output/test'),
            c_map=map_blue,
            icon_name=name,
            glyph_d_contents=data
        )

main()

#handle_color_map(
#    map_blue,
#    'leros',
#    glyph_d_contents='m24.131 39.933v-0.01s0.406-0.086 0.825-0.175c0.529-0.112 0.908-0.579 0.908-1.12v-13.939c0-0.544 0.383-1.013 0.916-1.122 2.446-0.499 9.121-1.861 11.774-2.403 0.272-0.055 0.554 0.014 0.77 0.19 0.215 0.175 0.34 0.438 0.341 0.715l0.044 18.261c8e-3 0.533-0.143 1.061-0.437 1.515-0.392 0.603-1.008 1.026-1.711 1.175-0.547 0.116-1.122 0.238-1.668 0.354-0.703 0.15-1.438 0.013-2.041-0.379-0.603-0.391-1.026-1.007-1.175-1.711-0.023-0.104-0.045-0.209-0.067-0.314-0.15-0.704-0.013-1.438 0.379-2.041s1.007-1.026 1.711-1.176c0.546-0.116 1.121-0.238 1.667-0.354 0.087-0.018 0.174-0.032 0.262-0.042l0.768-0.155c0.535-0.108 0.919-0.578 0.919-1.123v-8.171c0-0.233-0.105-0.454-0.285-0.602-0.181-0.148-0.418-0.207-0.647-0.161-2.091 0.419-7.137 1.432-9.217 1.85-0.535 0.107-0.92 0.577-0.92 1.123v12.752c0.014 0.544-0.136 1.084-0.437 1.547-0.392 0.603-1.007 1.026-1.711 1.175-0.546 0.116-1.121 0.238-1.667 0.354-0.704 0.15-1.438 0.013-2.041-0.378-0.604-0.392-1.027-1.008-1.176-1.712-0.022-0.104-0.045-0.209-0.067-0.314-0.149-0.704-0.013-1.438 0.379-2.041s1.007-1.026 1.711-1.176c0.546-0.116 1.121-0.238 1.667-0.354 0.075-0.016 0.151-0.028 0.226-0.038z'
#)

#generate_svg(
#    glyph_d_contents='m24.131 39.933v-0.01s0.406-0.086 0.825-0.175c0.529-0.112 0.908-0.579 0.908-1.12v-13.939c0-0.544 0.383-1.013 0.916-1.122 2.446-0.499 9.121-1.861 11.774-2.403 0.272-0.055 0.554 0.014 0.77 0.19 0.215 0.175 0.34 0.438 0.341 0.715l0.044 18.261c8e-3 0.533-0.143 1.061-0.437 1.515-0.392 0.603-1.008 1.026-1.711 1.175-0.547 0.116-1.122 0.238-1.668 0.354-0.703 0.15-1.438 0.013-2.041-0.379-0.603-0.391-1.026-1.007-1.175-1.711-0.023-0.104-0.045-0.209-0.067-0.314-0.15-0.704-0.013-1.438 0.379-2.041s1.007-1.026 1.711-1.176c0.546-0.116 1.121-0.238 1.667-0.354 0.087-0.018 0.174-0.032 0.262-0.042l0.768-0.155c0.535-0.108 0.919-0.578 0.919-1.123v-8.171c0-0.233-0.105-0.454-0.285-0.602-0.181-0.148-0.418-0.207-0.647-0.161-2.091 0.419-7.137 1.432-9.217 1.85-0.535 0.107-0.92 0.577-0.92 1.123v12.752c0.014 0.544-0.136 1.084-0.437 1.547-0.392 0.603-1.007 1.026-1.711 1.175-0.546 0.116-1.121 0.238-1.667 0.354-0.704 0.15-1.438 0.013-2.041-0.378-0.604-0.392-1.027-1.008-1.176-1.712-0.022-0.104-0.045-0.209-0.067-0.314-0.149-0.704-0.013-1.438 0.379-2.041s1.007-1.026 1.711-1.176c0.546-0.116 1.121-0.238 1.667-0.354 0.075-0.016 0.151-0.028 0.226-0.038z'
#)

#OUTPUT_DIR = Path('./output')